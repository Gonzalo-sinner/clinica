name: Sync manual desde repo original

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (destino) - tu repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Checkout (origen) - repo original en carpeta upstream
        uses: actions/checkout@v4
        with:
          repository: lucas12cn/IDW-38
          path: upstream
          fetch-depth: 0

      - name: Asegurar rama main en destino
        run: |
          if git show-ref --verify --quiet refs/heads/main; then
            git checkout main
          elif git show-ref --verify --quiet refs/heads/master; then
            git checkout master
          else
            git checkout -b main
          fi

      - name: Copiar archivos desde upstream (excluir .git y workflows)
        run: |
          rsync -av --delete --exclude '.git' --exclude '.github' upstream/ ./

      - name: Configurar identidad del commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Mostrar estado git (debug)
        run: |
          git status --porcelain
          git --no-pager diff --name-status || true

      - name: Commit y push si hay cambios
        run: |
          if git add -A && git diff --cached --quiet; then
            echo "No hay cambios para commitear."
          else
            git commit -m "Sync autom√°tico desde lucas12cn/IDW-38 [workflow]" || echo "No se pudo commitear"
            git push origin HEAD
          fi
